{{- if .Values.billing.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-billing-code
data:
  server.py: |
    from http.server import HTTPServer, BaseHTTPRequestHandler
    import json
    import os

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            self.send_response(200)
            self.send_header('Content-Type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            
            if self.path == '/health':
                self.wfile.write(json.dumps({"status": "ok"}).encode())
            elif self.path.startswith('/api/v1/organizations/') and '/usage' in self.path:
                self.wfile.write(json.dumps({
                    "total_actions": 0,
                    "active_storage_gbh": 0,
                    "estimated_cost_cents": 0
                }).encode())
            elif self.path.startswith('/api/v1/organizations/') and '/namespaces' in self.path:
                self.wfile.write(json.dumps([
                    {"id": "1", "name": "default", "status": "active"}
                ]).encode())
            elif self.path.startswith('/api/v1/organizations/') and '/subscription' in self.path:
                self.wfile.write(json.dumps({
                    "plan": "free",
                    "status": "active",
                    "actions_included": 100000
                }).encode())
            else:
                self.wfile.write(json.dumps({"path": self.path}).encode())
        
        def do_OPTIONS(self):
            self.send_response(200)
            self.send_header('Access-Control-Allow-Origin', '*')
            self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
            self.send_header('Access-Control-Allow-Headers', 'Content-Type')
            self.end_headers()
        
        def log_message(self, format, *args):
            pass

    print("Billing API running on :8082")
    HTTPServer(('0.0.0.0', 8082), Handler).serve_forever()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-billing
  labels:
    app: billing
    release: {{ .Release.Name }}
spec:
  replicas: {{ .Values.billing.replicas }}
  selector:
    matchLabels:
      app: billing
      release: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: billing
        release: {{ .Release.Name }}
    spec:
      containers:
        - name: billing
          image: "{{ .Values.billing.image.repository }}:{{ .Values.billing.image.tag }}"
          command: ["python", "/app/server.py"]
          ports:
            - containerPort: 8082
          volumeMounts:
            - name: code
              mountPath: /app
          resources:
            {{- toYaml .Values.billing.resources | nindent 12 }}
      volumes:
        - name: code
          configMap:
            name: {{ .Release.Name }}-billing-code
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-billing
  labels:
    app: billing
    release: {{ .Release.Name }}
spec:
  type: ClusterIP
  ports:
    - port: 8082
      targetPort: 8082
  selector:
    app: billing
    release: {{ .Release.Name }}
---
{{- if .Values.billing.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-billing
  labels:
    app: billing
    release: {{ .Release.Name }}
  {{- with .Values.billing.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  ingressClassName: {{ .Values.billing.ingress.className }}
  {{- if .Values.billing.ingress.tls }}
  tls:
    {{- range .Values.billing.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.billing.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            pathType: {{ .pathType }}
            backend:
              service:
                name: {{ $.Release.Name }}-billing
                port:
                  number: 8082
          {{- end }}
    {{- end }}
{{- end }}
{{- end }}
